{% extends 'base.html' %}
{% load form_tags %}
{% block content %}
<div class="bg-white p-6 rounded-lg shadow-lg max-w-4xl mx-auto">
    <h2 class="text-2xl font-bold mb-6 text-blue-800">Create New Batch</h2>
    
    <form method="post" id="batch-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        {% csrf_token %}
        
        <div>
            <label for="{{ form.spec_template.id_for_label }}" class="block text-sm font-medium text-gray-700">Specification Template</label>
            {{ form.spec_template|add_class:"w-full p-2 border rounded-md" }}
            {% if form.spec_template.errors %}
                <p class="text-red-500 text-xs mt-1">{{ form.spec_template.errors.as_text }}</p>
            {% endif %}
        </div>

        <div>
            <label for="id_sku" class="block text-sm font-medium text-gray-700">SKU</label>
            {{ form.sku|add_class:"w-full p-2 border rounded-md" }}
            {% if form.sku.errors %}
                <p class="text-red-500 text-xs mt-1">{{ form.sku.errors.as_text }}</p>
            {% endif %}
        </div>

        <div>
            <label for="id_prefix" class="block text-sm font-medium text-gray-700">Prefix (Auto-filled from SKU)</label>
            <input type="text" id="id_prefix" name="prefix" readonly value="{{ form.instance.sku.code|default:'' }}" class="w-full p-2 border rounded-md bg-gray-100 text-gray-700">
        </div>

        <div>
            <label for="id_batch_date" class="block text-sm font-medium text-gray-700">Batch Date</label>
            {{ form.batch_date|add_class:"w-full p-2 border rounded-md" }}
            {% if form.batch_date.errors %}
                <p class="text-red-500 text-xs mt-1">{{ form.batch_date.errors.as_text }}</p>
            {% endif %}
        </div>

        <div>
            <label for="id_quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
            {{ form.quantity|add_class:"w-full p-2 border rounded-md" }}
            {% if form.quantity.errors %}
                <p class="text-red-500 text-xs mt-1">{{ form.quantity.errors.as_text }}</p>
            {% endif %}
        </div>

        <div id="dynamic-fields" class="col-span-1 sm:col-span-2 md:col-span-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            {# Include the partial template here for initial render and validation failures #}
            {% include 'inventory/create_batch_dynamic_fields.html' with form=form %}
        </div>
        
        <div class="col-span-1 sm:col-span-2 md:col-span-3 flex justify-end space-x-4 mt-2">
            <a href="{% url 'batch_list' %}" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition">
                ‚Üê Back
            </a>
            <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
                Create
            </button>
        </div>
    </form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('batch-form');
        const skuSelect = document.getElementById('id_sku');
        const prefixField = document.getElementById('id_prefix');
        const templateSelect = document.getElementById('id_spec_template');
        const dynamicFieldsContainer = document.getElementById('dynamic-fields');

        function updatePrefix() {
            const selectedOption = skuSelect.options[skuSelect.selectedIndex];
            // Uses the selected option's visible text for the prefix
            prefixField.value = selectedOption.value ? selectedOption.text.trim() : ''; 
        }

        function updateDynamicFields() {
            // Save current dynamic field values to restore them later
            const currentValues = {};
            dynamicFieldsContainer.querySelectorAll('input, select, textarea').forEach(field => {
                currentValues[field.name] = field.value;
            });

            const formData = new FormData(form);
            
            // Send POST request with current form data to let Django render new fields
            fetch("{% url 'create_batch' %}", {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.text())
            .then(html => {
                // The response HTML is the content of the create_batch_dynamic_fields.html partial
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // The root element of the partial template is the dynamic-fields div
                const newDynamicFields = doc.getElementById('dynamic-fields');

                if (newDynamicFields) {
                    dynamicFieldsContainer.innerHTML = newDynamicFields.innerHTML;
                    
                    // Restore saved values
                    dynamicFieldsContainer.querySelectorAll('input, select, textarea').forEach(field => {
                        if (currentValues[field.name] !== undefined) {
                            field.value = currentValues[field.name];
                        }
                    });

                    updatePrefix(); // Ensure prefix is updated after form redraw
                }
            })
            .catch(error => console.error('Error updating dynamic fields:', error));
        }

        // Attach listeners
        skuSelect.addEventListener('change', updatePrefix); 
        
        if (templateSelect) {
            templateSelect.addEventListener('change', updateDynamicFields);
        }

        // Initial setup
        updatePrefix(); 
    });
</script>
</div>
{% endblock %}